---
title: "Diagnóstico por país"
author: "Antonio Paulo Steffen Neto"
date: "2025-12-03"
output: html_document
---

## Diagnóstico Inicial de Desempenho por País

```{r}
library(tidyverse)

# 1. Carregamento dos dados (Assumindo que você tem o cuisines carregado)
# cuisines <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/main/data/2025/2025-09-16/cuisines.csv')

# 2. Sumarização das Métricas de Desempenho por País
diagnostico_paises <- cuisines %>%
  group_by(country) %>%
  summarise(
    # Frequência
    frequencia_receitas = n(),
    
    # Métricas de Avaliação
    media_ratings = mean(avg_rating, na.rm = TRUE),
    total_ratings_somados = sum(total_ratings, na.rm = TRUE),
    total_reviews_somados = sum(reviews, na.rm = TRUE),
    
    # Indicador de Qualidade (contagem de NAs em ratings)
    observacoes_validas = sum(!is.na(avg_rating))
  ) %>%
  # Ordenar pela popularidade geral (total de ratings)
  arrange(desc(total_ratings_somados))

print("--- Diagnóstico Inicial de Desempenho por País (Top 15) ---")
print(head(diagnostico_paises, 15))
```

## Plotagem em Mapa

```{r}
# Plotagem da Média de Avaliação (filtrando ruído)
plot_ratings_mapa_alternativa <- diagnostico_paises %>%
  filter(observacoes_validas >= 10) %>% # Filtra culinárias com pelo menos 10 avaliações
  top_n(20, total_ratings_somados) %>%  # Foca nas 20 mais populares
  mutate(country = reorder(country, media_ratings)) %>%
  
  ggplot(aes(x = country, y = media_ratings, fill = total_ratings_somados)) +
  geom_col() +
  coord_flip() +
  scale_fill_viridis_c(name = "Total de Engajamento") + # Cor por engajamento total
  labs(
    title = "Qualidade Percebida das Culinárias (Avg. Rating)",
    subtitle = "Filtro: Culinárias com 10 ou mais avaliações",
    x = "País / Culinária",
    y = "Média de Avaliação"
  ) +
  theme_minimal()

print(plot_ratings_mapa_alternativa)
```
## Mapa

```{r}
library(tidyverse)
library(rnaturalearth) # Para obter dados de mapas globais
library(sf)            # Para trabalhar com dados geoespaciais

# --- 1. PREPARAÇÃO DOS DADOS E PADRONIZAÇÃO DE NOMES ---

# 1. Tabela de Sumarização (Reusando a lógica anterior)
diagnostico_paises <- cuisines %>%
  group_by(country) %>%
  summarise(
    frequencia_receitas = n(),
    media_ratings = mean(avg_rating, na.rm = TRUE),
    total_ratings_somados = sum(total_ratings, na.rm = TRUE),
    observacoes_validas = sum(!is.na(avg_rating))
  ) %>%
  filter(observacoes_validas >= 10) # Filtra dados não confiáveis

# 2. Tabela de Conversão Manual
# Mapeia nomes de culinárias (country) para nomes formais de países (name_long)
tabela_conversao <- tribble(
  ~country,                       ~name_long,
  "Mexican",                      "Mexico",
  "Italian",                      "Italy",
  "Greek",                        "Greece",
  "Japanese",                     "Japan",
  "German",                       "Germany",
  "Jewish",                       "Israel", # Mapeamento aproximado para a região cultural
  "Thai",                         "Thailand",
  "French",                       "France",
  "Indian",                       "India",
  "Chinese",                      "China",
  "Australian and New Zealander", "Australia", # Usaremos Austrália como representante
  "British",                      "United Kingdom",
  "Spanish",                      "Spain",
  "Cuban",                        "Cuba",
  "Filipino",                     "Philippines",
  "Korean",                       "South Korea",
  # Adicione mais mapeamentos conforme necessário para seus Top N
)

# 3. Unir o Diagnóstico com a Conversão
dados_mapeamento <- diagnostico_paises %>%
  inner_join(tabela_conversao, by = "country")

# --- 2. PREPARAÇÃO DO MAPA GEOGRÁFICO (SHAPEFILE) ---

# Carregar dados globais de países (world)
mapa_mundi <- ne_countries(scale = "medium", returnclass = "sf") %>%
  # Simplificar a projeção para uma visualização mais limpa
  select(name_long, geometry)

# --- 3. JUNÇÃO E PLOTAGEM DO MAPA ---

# 1. Juntar os dados da culinária com os dados geográficos
mapa_final <- mapa_mundi %>%
  left_join(dados_mapeamento, by = "name_long")

# 2. Plotar o Mapa-Múndi (Cor por Média de Avaliação)
plot_mapa <- ggplot(data = mapa_final) +
  # Camada de países: cor cinza para países sem dados
  geom_sf(aes(fill = media_ratings), color = "gray80", linewidth = 0.1) +
  
  # Usar uma escala de cores perceptualmente uniforme (Viridis)
  scale_fill_viridis_c(
    option = "plasma", 
    direction = -1,
    name = "Média de Avaliação (1.0-5.0)",
    na.value = "gray90" # Países sem dados ficam cinza claro
  ) +
  
  labs(
    title = "Média de Avaliação das Culinárias Populares",
    subtitle = "Cores representam a qualidade percebida (avg_rating) por país de origem.",
    caption = "Países mapeados manualmente. Filtro: Observações Válidas >= 10."
  ) +
  theme_void() + # Remove eixos e grade para um visual de mapa limpo
  # Centralizar e ajustar a projeção para um mapa-múndi clássico
  theme(legend.position = "bottom",
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

print(plot_mapa)
```

